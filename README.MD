# WareHouse Control

Сервис, который позволяет:
- создавать товары(Items), 
- редактировать/обновлять товары, 
- удалять их(в режиме soft-delete)
с автоматизированным сохранением версий товара(old/new) в отдельной таблице посредством 
использования триггера в БД.

---

## Возможности

### Пользователи

* Регистрация (`signup`) с выбором роли;
* Авторизация (`login`) по username + пароль c выбором роли;
* JWT-аутентификация через **HTTP-only cookie**.

### Роли и права

Внутри приложения реализована работа в соответствии с 4мя ролями и соответствующим им правам:

| Роль    | Edit | Delete | History CSV |
|---------|------|--------|-------------|
| admin   | ✅   | ✅     | ✅          |
| manager | ✅   | ✅     | ❌          |
| auditor | ❌   | ❌     | ✅          |
| viewer  | ❌   | ❌     | ❌          |

## Архитектура

### Backend

* Язык: **Go**
* HTTP-фреймворк: **Gin**
* Аутентификация: **JWT (cookie-based)**
* Middleware:

  * `RequestID` - логирование каждого запроса 
  * `RequireAuth` - проверка авторизации и корректности роли

* Слои:

  * handlers - HTTP-обработчики
  * mwauthlog - чтение и инъекция реквест-зависимых данных
  * service - бизнес-логика, проверка ролей
  * policy - хранилище зависимостей ролей и доступов
  * engine - конфигурация роутов и http-движка с учетом окружения(test/prod)
  * repository - работа с БД
  * model - хранилище описания внутренних структур и констант приложения

### Database

* PostgreSQL

### Frontend

* Один HTML-файл
* UI меняется динамически в зависимости от роли
* Вся авторизация основана на cookie (без хранения JWT в JS)

---

## API

### Auth

```
POST /auth/signup
POST /auth/login
```

### Items (требуется авторизация)

```
GET    /items      - получение всех Item
POST   /items      - создание Item

GET    /items/:id         - получение Item по ID
DELETE /items/:id         - удаление Item по ID
PATCH  /items/:id         - обновление Item по ID

GET    /items/:id/history - получение History товара по его ID
GET    /items/history     - получение History всех товаров

GET    /items/:id/history/csv   - CSV: получение History товара по его ID
GET    /items/history/csv       - CSV: получение History всех товаров
GET    /items/csv               - CSV: получение всех Item
```

---

## UI

* Web UI доступен по адресу: `http://localhost:8080/ui`
* API - на том же хосте.

### Поведение UI

В зависимости от роли пользователя интерфейс отображает:
- **форму логина/регистрации**(скрыта, если пользователь залогинен);
- **форму для создания нового товара**(доступно для админа и менеджера);
- **таблицу со списком существующих товаров** с применением сортировки по полю
(выбор из дропдауна) и фильтрации **по времени создания**, при этом удаленные 
товары доступны только для ролей админа и аудитора. В колонке "Actions" 
таблицы реализованы кнопки удаления/обновления/скачивания истории изменений 
в CSV для каждого Item ID;
- **таблицу с историей изменений товаров**(доступна только админу и аудитору) с 
применением сортировки по полю и **времени самого изменения**.

Над обеими таблицами в блоке настройки параметров запроса(сортировка/фильтр) имеется 
кнопка "CSV", которая запускает скачивание CSV-файла с применением текущих параметров 
сортировки/фильтра.

Выбранную при регистрации роль можно обойти/временно подменить при авторизации. Для смены 
роли достаточно разлогиниться и выбрать при логине другую роль для удобства тестирования.

P.S. текущую роль можно увидеть прямо под кнопкой "Logout" в левом верхнем углу.

---

## Безопасность (ключевые решения)

* JWT хранится **только в http-only cookie**
* Frontend **не имеет доступа** к токену
* `role`, `username` берутся **только из JWT на backend**
* Клиент не передаёт `username` ни в одном запросе

---

## Запуск проекта

1. Склонировать репозиторий
2. Создать файл окружения из примера(скопировать и переименовать), внести в него необходимые правки:

```bash
cp .env.example .env
```

3. Запустить приложение:

```bash
docker-compose up
```

4. Открыть в браузере:

```
http://localhost:8080/ui
```

## Тестирование

Запуск всех тестов из корня проекта:

```bash
go test ./...
```