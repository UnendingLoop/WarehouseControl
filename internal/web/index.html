<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Items Service UI</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        h2 {
            margin-top: 30px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        input,
        select,
        button {
            padding: 4px 6px;
        }

        .actions button {
            margin-right: 4px;
        }

        .danger {
            color: red;
        }
    </style>
</head>

<body>

    <h1>Items Service</h1>

    <!-- ================= AUTH ================= -->

    <div id="auth-block">
        <h2>Auth</h2>

        <div class="controls">
            <input id="authusername" placeholder="username" />
            <input id="authpassword" placeholder="password" type="password" />
            <select id="authrole">
                <option value="admin">admin</option>
                <option value="manager">manager</option>
                <option value="viewer">viewer</option>
                <option value="auditor">auditor</option>
            </select>
        </div>

        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>
    </div>

    <!-- ================= MAIN ================= -->

    <div id="main-block" class="hidden">
        <div class="controls">
            <span id="userinfo"></span>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- ===== CREATE ITEM ===== -->

        <div id="create-item-block" class="hidden">
            <h2>Create Item</h2>
            <div class="controls">
                <input id="ci-title" placeholder="title" />
                <input id="ci-desc" placeholder="description" />
                <input id="ci-price" placeholder="price" type="number" />
                <input id="ci-amount" placeholder="amount" type="number" />
                <label>
                    visible <input id="ci-visible" type="checkbox" />
                </label>
                <button onclick="createItem()">Create</button>
            </div>
        </div>

        <!-- ===== ITEMS LIST ===== -->

        <h2>Items</h2>

        <div class="controls">
            <select id="items-order-by">
                <option value="">order by</option>
                <option value="id">id</option>
                <option value="title">title</option>
                <option value="price">price</option>
                <option value="availability">availability</option>
                <option value="visibility">visibility</option>
            </select>

            <label>ASC <input type="checkbox" id="items-asc"></label>
            <label>DESC <input type="checkbox" id="items-desc"></label>

            <input type="datetime-local" id="items-from">
            <input type="datetime-local" id="items-to">

            <input type="number" id="items-page" placeholder="page">
            <input type="number" id="items-limit" placeholder="limit">

            <button onclick="loadItems()">Load</button>
            <button onclick="downloadItemsCSV()">Download CSV</button>
        </div>

        <table id="items-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Visible</th>
                    <th>Amount</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- ===== HISTORY (ADMIN + AUDITOR) ===== -->

        <div id="history-block" class="hidden">
            <h2>Items History</h2>

            <div class="controls">
                <select id="history-order-by">
                    <option value="">order by</option>
                    <option value="id">id</option>
                    <option value="action">action</option>
                    <option value="version">version</option>
                    <option value="actor">actor</option>
                </select>

                <label>ASC <input type="checkbox" id="history-asc"></label>
                <label>DESC <input type="checkbox" id="history-desc"></label>

                <input type="datetime-local" id="history-from">
                <input type="datetime-local" id="history-to">

                <input type="number" id="history-page" placeholder="page">
                <input type="number" id="history-limit" placeholder="limit">

                <button onclick="loadHistory()">Load</button>
                <button onclick="downloadHistoryCSV()">Download CSV</button>
            </div>

            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ItemID</th>
                        <th>Version</th>
                        <th>Action</th>
                        <th>Actor</th>
                        <th>ChangedAt</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        /* ================= HELPERS ================= */

        function getToken() {
            return localStorage.getItem("jwt");
        }

        function setToken(token) {
            localStorage.setItem("jwt", token);
        }

        function authHeaders() {
            return {
                "Authorization": "Bearer " + getToken(),
                "Content-Type": "application/json"
            };
        }

        function parseJWT(token) {
            const payload = token.split(".")[1];
            return JSON.parse(atob(payload));
        }

        function qs(params) {
            const q = new URLSearchParams();
            Object.entries(params).forEach(([k, v]) => {
                if (v !== null && v !== "" && v !== undefined) {
                    q.append(k, v);
                }
            });
            return q.toString();
        }

        /* ================= AUTH ================= */

        async function signup() {
            await auth("/auth/signup");
        }

        async function login() {
            await auth("/auth/login");
        }

        async function auth(url) {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: authusername.value,
                    password: authpassword.value,
                    role: authrole.value
                })
            });

            if (!res.ok) {
                alert("auth failed");
                return;
            }

            const data = await res.json();
            setToken(data.token);
            init();
        }

        function logout() {
            localStorage.removeItem("jwt");
            location.reload();
        }

        /* ================= INIT ================= */

        function init() {
            const token = getToken();
            if (!token) return;

            const user = parseJWT(token);

            auth - block.classList.add("hidden");
            main - block.classList.remove("hidden");

            userinfo.textContent = `User: ${user.username}, role: ${user.role}`;

            if (user.role === "admin" || user.role === "manager") {
                create - item - block.classList.remove("hidden");
            }

            if (user.role === "admin" || user.role === "auditor") {
                history - block.classList.remove("hidden");
            }

            loadItems();
            if (!history - block.classList.contains("hidden")) {
                loadHistory();
            }
        }

        /* ================= ITEMS ================= */

        async function loadItems() {
            const query = qs({
                order_by: items - order - by.value,
                asc: items - asc.checked,
                desc: items - desc.checked,
                from: items - from.value,
                to: items - to.value,
                page: items - page.value,
                limit: items - limit.value
            });

            const res = await fetch("/items?" + query, { headers: authHeaders() });
            const items = await res.json();

            const tbody = items - table.querySelector("tbody");
            tbody.innerHTML = "";

            items.forEach(i => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
      <td>${i.id}</td>
      <td contenteditable="false">${i.title}</td>
      <td contenteditable="false">${i.description || ""}</td>
      <td contenteditable="false">${i.price}</td>
      <td contenteditable="false">${i.visible}</td>
      <td contenteditable="false">${i.available_amount}</td>
      <td>${i.created_at}</td>
      <td>${i.updated_at}</td>
      <td class="actions"></td>
    `;

                renderActions(tr, i);
                tbody.appendChild(tr);
            });
        }

        function renderActions(tr, item) {
            const user = parseJWT(getToken());
            const cell = tr.querySelector(".actions");

            if (user.role === "admin" || user.role === "manager") {
                const edit = document.createElement("button");
                edit.textContent = "Edit";
                edit.onclick = () => toggleEdit(tr, item.id, edit);
                cell.appendChild(edit);

                const del = document.createElement("button");
                del.textContent = "Delete";
                del.className = "danger";
                del.onclick = () => deleteItem(item.id);
                cell.appendChild(del);
            }

            if (user.role === "admin" || user.role === "auditor") {
                const hist = document.createElement("button");
                hist.textContent = "History CSV";
                hist.onclick = () => window.location = `/items/${item.id}/history/csv`;
                cell.appendChild(hist);
            }
        }

        async function toggleEdit(tr, id, btn) {
            const editable = btn.textContent === "Edit";
            btn.textContent = editable ? "Save" : "Edit";

            const tds = tr.querySelectorAll("td");
            [1, 2, 3, 4, 5].forEach(i => tds[i].contentEditable = editable);

            if (!editable) {
                const body = {
                    title: tds[1].textContent,
                    description: tds[2].textContent,
                    price: Number(tds[3].textContent),
                    visible: tds[4].textContent === "true",
                    available_amount: Number(tds[5].textContent)
                };

                await fetch(`/items/${id}`, {
                    method: "PATCH",
                    headers: authHeaders(),
                    body: JSON.stringify(body)
                });

                loadItems();
            }
        }

        async function deleteItem(id) {
            await fetch(`/items/${id}`, {
                method: "DELETE",
                headers: authHeaders()
            });
            loadItems();
        }

        /* ================= CREATE ================= */

        async function createItem() {
            await fetch("/items", {
                method: "POST",
                headers: authHeaders(),
                body: JSON.stringify({
                    title: ci - title.value,
                    description: ci - desc.value,
                    price: Number(ci - price.value),
                    available_amount: Number(ci - amount.value),
                    visible: ci - visible.checked
                })
            });

            loadItems();
        }

        /* ================= CSV ================= */

        function downloadItemsCSV() {
            const query = qs({
                order_by: items - order - by.value,
                asc: items - asc.checked,
                desc: items - desc.checked,
                from: items - from.value,
                to: items - to.value,
                page: items - page.value,
                limit: items - limit.value
            });

            window.location = "/items/csv?" + query;
        }

        /* ================= HISTORY ================= */

        async function loadHistory() {
            const query = qs({
                order_by: history - order - by.value,
                asc: history - asc.checked,
                desc: history - desc.checked,
                from: history - from.value,
                to: history - to.value,
                page: history - page.value,
                limit: history - limit.value
            });

            const res = await fetch("/items/history?" + query, {
                headers: authHeaders()
            });

            const data = await res.json();
            const tbody = history - table.querySelector("tbody");
            tbody.innerHTML = "";

            data.forEach(h => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${h.id}</td>
      <td>${h.item_id}</td>
      <td>${h.version}</td>
      <td>${h.action}</td>
      <td>${h.changed_by}</td>
      <td>${h.changed_at}</td>
    `;
                tbody.appendChild(tr);
            });
        }

        function downloadHistoryCSV() {
            const query = qs({
                order_by: history - order - by.value,
                asc: history - asc.checked,
                desc: history - desc.checked,
                from: history - from.value,
                to: history - to.value,
                page: history - page.value,
                limit: history - limit.value
            });

            window.location = "/items/history/csv?" + query;
        }

        /* ================= START ================= */

        init();
    </script>

</body>

</html>