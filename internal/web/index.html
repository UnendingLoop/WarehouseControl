<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Items Service UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        th {
            background: #eee;
        }

        .hidden {
            display: none;
        }

        .actions button {
            margin-right: 4px;
        }

        .block {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h2>Items Service</h2>
    <button id="logoutBtn" class="hidden">Logout</button>
    <div id="roleInfo" class="hidden"></div>
    <div id="authBlock" class="block">
        <h3>Auth</h3>
        <input id="username" placeholder="username" />
        <input id="password" type="password" placeholder="password" />
        <select id="role">
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="viewer">viewer</option>
            <option value="auditor">auditor</option>
        </select>
        <br /><br />
        <button onclick="signup()">Sign up</button>
        <button onclick="login()">Login</button>
    </div>

    <div id="createItemBlock" class="block hidden">
        <h3>Create Item</h3>
        <input id="c_title" placeholder="title" />
        <input id="c_desc" placeholder="description" />
        <input id="c_price" type="number" placeholder="price" />
        <input id="c_amount" type="number" placeholder="amount" />
        <label><input id="c_visible" type="checkbox" /> visible</label>
        <br /><br />
        <button onclick="createItem()">Create</button>
    </div>

    <div id="itemsBlock" class="block hidden">
        <h3>Items</h3>
        <div>
            Order by <select id="items_order">
                <option value="id">id</option>
                <option value="title">title</option>
                <option value="price">price</option>
                <option value="availability">amount</option>
                <option value="visibility">visibility</option>
            </select>
            <select id="items_orderDir">
                <option value="asc">ASC</option>
                <option value="desc">DESC</option>
            </select></br>
            Item created from <input id="items_from" type="datetime-local" placeholder="from (RFC3339)" />
            to <input id="items_to" type="datetime-local" placeholder="to (RFC3339)" />
            <button onclick="loadItems()">Load</button>
            <button onclick="downloadItemsCSV()">CSV</button>
        </div>
        <table id="itemsTable"></table>
    </div>

    <div id="historyBlock" class="block hidden">
        <h3>History</h3>
        <div>
            Order by <select id="hist_order">
                <option value="id">id</option>
                <option value="item_id">id</option>
                <option value="action">action</option>
                <option value="version">version</option>
                <option value="actor">actor</option>
            </select>
            <select id="hist_orderDir">
                <option value="asc">ASC</option>
                <option value="desc">DESC</option>
            </select></br>
            Action from <input id="hist_from" type="datetime-local" />
            to <input id="hist_to" type="datetime-local" />
            <button onclick="loadHistory()">Load</button>
            <button onclick="downloadHistoryCSV()">CSV</button>
        </div>
        <table id="historyTable"></table>
    </div>

    <script>
        let currentRole = null;

        async function signup() {
            await apiFetch('/auth/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(getAuthPayload()) });
            onAuthSuccess();
        }
        async function login() {
            await apiFetch('/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(getAuthPayload()) });
            onAuthSuccess();
        }
        function getAuthPayload() {
            return { username: username.value, password: password.value, role: role.value };
        }
        function onAuthSuccess() {
            currentRole = role.value;
            authBlock.classList.add('hidden');
            logoutBtn.classList.remove('hidden');

            roleInfo.classList.remove('hidden');
            roleInfo.innerText = `Current role: ${currentRole}`;

            itemsBlock.classList.remove('hidden');
            if (currentRole === 'admin' || currentRole === 'manager') createItemBlock.classList.remove('hidden');
            if (currentRole === 'admin' || currentRole === 'auditor') historyBlock.classList.remove('hidden');
            loadItems();
        }
        logoutBtn.onclick = () => handleUnauthorized();

        function handleUnauthorized() {
            currentRole = null;

            itemsBlock.classList.add('hidden');
            historyBlock.classList.add('hidden');
            createItemBlock.classList.add('hidden');
            logoutBtn.classList.add('hidden');

            roleInfo.classList.add('hidden');
            roleInfo.innerText = '';

            authBlock.classList.remove('hidden');
            location.reload()
            alert('Session expired. Please login again.')
        }

        async function createItem() {
            await apiFetch('/items', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                    title: c_title.value, description: c_desc.value, price: +c_price.value, available_amount: +c_amount.value, visible: c_visible.checked
                })
            });
            loadItems();
        }

        async function loadItems() {
            try {
                const qs = new URLSearchParams()
                if (items_order.value) qs.append('order_by', items_order.value)
                if (items_orderDir.value) qs.append(items_orderDir.value, "true")
                if (items_from.value) qs.append('from', normalizeTime(items_from.value))
                if (items_to.value) qs.append('to', normalizeTime(items_to.value))
                const res = await apiFetch('/items?' + qs)
                const data = await res.json()
                renderItems(data)
            } catch (e) {
            }
        }

        function normalizeTime(val) {
            if (!val) return null
            return val.length === 16 ? val + ':00Z' : val
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, options)

            if (res.status === 401) {
                handleUnauthorized()
                throw new Error('Unauthorized')
            }

            return res
        }

        function renderItems(items) {
            itemsTable.innerHTML = '<tr><th>ID</th><th>Title</th><th>Description</th><th>Price</th><th>Amount</th><th>Visible</th><th>Deleted</th><th>Actions</th></tr>';
            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${it.id}</td><td contenteditable="false">${it.title}</td><td contenteditable="false">${it.description}</td><td contenteditable="false">${it.price}</td><td contenteditable="false">${it.available_amount}</td><td contenteditable="false">${it.visible}</td><td contenteditable="false">${it.deleted_at}</td>`;
                const act = document.createElement('td'); act.className = 'actions';
                if (currentRole !== 'viewer' && currentRole !== 'auditor') {
                    const edit = document.createElement('button'); edit.textContent = 'Edit';
                    edit.onclick = () => toggleEdit(tr, it.id, edit);
                    act.appendChild(edit);
                }
                if (currentRole === 'admin' || currentRole === 'manager') {
                    const del = document.createElement('button'); del.textContent = 'Delete'; del.onclick = () => deleteItem(it.id);
                    act.appendChild(del);
                }
                if (currentRole === 'admin' || currentRole === 'auditor') {
                    const h = document.createElement('button'); h.textContent = 'History CSV'; h.onclick = () => window.open(`/items/${it.id}/history/csv`);
                    act.appendChild(h);
                }
                tr.appendChild(act); itemsTable.appendChild(tr);
            });
        }

        async function toggleEdit(tr, id, btn) {
            const editing = btn.textContent === 'Save';
            const tds = tr.querySelectorAll('td');
            if (editing) {
                await apiFetch('/items/' + id, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                        title: tds[1].innerText,
                        description: tds[2].innerText,
                        price: +tds[3].innerText,
                        available_amount: +tds[4].innerText,
                        visible: tds[5].querySelector('input') ? tds[5].querySelector('input').checked : tds[5].innerText === 'true',
                    })
                });
                btn.textContent = 'Edit'; loadItems();
            } else {
                tds[1].contentEditable = tds[2].contentEditable = tds[3].contentEditable = tds[4].contentEditable = tds[5].contentEditable = true;
                btn.textContent = 'Save';
            }
        }
        async function deleteItem(id) { await apiFetch('/items/' + id, { method: 'DELETE' }); loadItems(); }

        async function loadHistory() {
            const qs = new URLSearchParams();
            if (hist_order.value) qs.append('order_by', hist_order.value);
            if (hist_orderDir.value) qs.append(hist_orderDir.value, "true");
            if (hist_from.value) qs.append('from', normalizeTime(hist_from.value));
            if (hist_to.value) qs.append('to', normalizeTime(hist_to.value));
            const res = await apiFetch('/items/history?' + qs); const data = await res.json();
            historyTable.innerHTML = '<tr><th>ID</th><th>ItemID</th><th>Action</th><th>Actor</th><th>Time</th></tr>';
            data.forEach(h => {
                historyTable.innerHTML += `<tr><td>${h.id}</td><td>${h.item_id}</td><td>${h.action}</td><td>${h.changed_by}</td><td>${h.changed_at}</td></tr>`;
            });
        }
        function downloadItemsCSV() { window.open('/items/csv'); }
        function downloadHistoryCSV() { window.open('/items/history/csv'); }
    </script>
</body>

</html>