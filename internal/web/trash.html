<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Warehouse Control</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        .hidden {
            display: none;
        }

        button {
            margin: 4px;
        }

        input,
        select {
            margin: 4px;
        }

        table {
            border-collapse: collapse;
            margin-top: 10px;
        }

        td,
        th {
            border: 1px solid #ccc;
            padding: 6px;
        }

        fieldset {
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <h2>Warehouse Control</h2>

    <!-- ================= AUTH ================= -->

    <div id="auth">
        <h3>Auth</h3>
        <input id="username" placeholder="username">
        <input id="password" type="password" placeholder="password">

        <select id="roleSelect">
            <option value="viewer">viewer</option>
            <option value="manager">manager</option>
            <option value="admin">admin</option>
            <option value="auditor">auditor</option>
        </select>

        <br>
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>
    </div>

    <!-- ================= APP ================= -->

    <div id="app" class="hidden">
        <button onclick="logout()">Logout</button>

        <h3>Items</h3>

        <!-- ===== SORT CONFIG ===== -->

        <fieldset>
            <legend>Sorting</legend>

            <label>
                Order by:
                <select id="orderBy">
                    <option value="id">id</option>
                    <option value="title">title</option>
                    <option value="price">price</option>
                    <option value="availability">availability</option>
                    <option value="visibility">visibility</option>
                </select>
            </label>

            <br>

            <label>
                <input type="radio" name="direction" value="asc" checked>
                ASC
            </label>

            <label>
                <input type="radio" name="direction" value="desc">
                DESC
            </label>

            <br>
            <button onclick="loadItems()">Apply sorting</button>
        </fieldset>

        <br>

        <button onclick="downloadItemsCSV()">Download items CSV</button>
        <button onclick="downloadHistoryCSV()">Download history CSV</button>

        <table id="itemsTable"></table>

        <!-- ===== CREATE ITEM ===== -->

        <div id="createItem" class="hidden">
            <h3>Create Item</h3>
            <input id="itemTitle" placeholder="title">
            <input id="itemPrice" type="number" placeholder="price">
            <input id="itemAmount" type="number" placeholder="available amount">
            <label>
                <input type="checkbox" id="itemVisible" checked>
                visible
            </label>
            <br>
            <button onclick="createItem()">Create</button>
        </div>
    </div>

    <script>
        /* ================= STATE ================= */

        let token = localStorage.getItem("token");
        let userRole = localStorage.getItem("role");

        /* ================= HELPERS ================= */

        function authHeaders() {
            return {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            };
        }

        function afterAuth(data) {
            token = data.token;
            userRole = data.role;

            localStorage.setItem("token", token);
            localStorage.setItem("role", userRole);

            init();
        }

        /* ================= AUTH ================= */

        function login() {
            fetch("/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: username.value,
                    password: password.value
                })
            })
                .then(r => r.json())
                .then(afterAuth);
        }

        function signup() {
            fetch("/auth/signup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: username.value,
                    password: password.value,
                    role: roleSelect.value
                })
            })
                .then(r => r.json())
                .then(afterAuth);
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        /* ================= INIT ================= */

        function init() {
            auth.classList.add("hidden");
            app.classList.remove("hidden");

            createItem.classList.add("hidden");

            if (userRole === "admin" || userRole === "manager") {
                createItem.classList.remove("hidden");
            }

            loadItems();
        }

        /* ================= ITEMS ================= */

        function buildQueryParams() {
            const orderByValue = orderBy.value;
            const direction = document.querySelector('input[name="direction"]:checked').value;

            let params = `order_by=${orderByValue}`;

            if (direction === "asc") {
                params += "&asc=true";
            } else {
                params += "&desc=true";
            }

            return params;
        }

        function loadItems() {
            const params = buildQueryParams();

            fetch(`/items?${params}`, {
                headers: authHeaders()
            })
                .then(r => r.json())
                .then(renderItems);
        }

        function renderItems(items) {
            let html = `
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Price</th>
      <th>Available</th>
      <th>Visible</th>
      <th>Actions</th>
    </tr>`;

            items.forEach(i => {
                html += `
      <tr>
        <td>${i.id}</td>
        <td>${i.title}</td>
        <td>${i.price}</td>
        <td>${i.available_amount}</td>
        <td>${i.visible}</td>
        <td>
          ${(userRole !== "viewer") ? `<button onclick="itemHistory(${i.id})">History</button>` : ""}
          ${(userRole === "admin") ? `<button onclick="deleteItem(${i.id})">Delete</button>` : ""}
        </td>
      </tr>`;
            });

            itemsTable.innerHTML = html;
        }

        function createItem() {
            fetch("/items", {
                method: "POST",
                headers: authHeaders(),
                body: JSON.stringify({
                    title: itemTitle.value,
                    price: Number(itemPrice.value),
                    available_amount: Number(itemAmount.value),
                    visible: itemVisible.checked
                })
            }).then(loadItems);
        }

        function deleteItem(id) {
            fetch(`/items/${id}`, {
                method: "DELETE",
                headers: authHeaders()
            }).then(loadItems);
        }

        function itemHistory(id) {
            window.open(`/items/${id}/history/csv`, "_blank");
        }

        /* ================= CSV ================= */

        function downloadItemsCSV() {
            const params = buildQueryParams();
            window.open(`/items/csv?${params}`, "_blank");
        }

        function downloadHistoryCSV() {
            const params = buildQueryParams();
            window.open(`/items/history/csv?${params}`, "_blank");
        }

        /* ================= AUTO INIT ================= */

        if (token && userRole) {
            init();
        }
    </script>

</body>

</html>